---
title: "Mining high density juvenile fish and redd sites in the ISEMP/CHaMP dataset; do particular habitat characteristics stick out in areas with lots of fish/redds?"
author:
  - name: Mike Ackerman
    affiliation: Biomark, Inc.
    email: mike.ackerman@merck.com
  - name: Kevin See
    affiliation: Biomark, Inc.
    email: kevin.see@merck.com
  - name: Richie Carmichael
    affiliation: Biomark, Inc.
    email: richard.carmichael@merck.com
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    smart: false
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_height: 6
    fig_width: 8
    pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
  bookdown::pdf_document2:
    fig_height: 6
    fig_width: 8
    includes:
      in_header: "../templates/header_ABS.tex"
    pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks2.lua
      - --lua-filter=../templates/pagebreak.lua
  bookdown::word_document2:
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    toc: yes
    pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
    reference_docx: "../templates/ReportTemplate.docx"
institute:
  - biomark: Biomark, Inc.
csl: "../templates/american-fisheries-society.csl"
---

```{r setup, echo = F, message = F, warning = F, results = 'hide'}
# load knitr for markdown
library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = F)

# load necessary libraries
library(tidyverse)
library(ggplot2)
library(janitor)

# themes and settings
theme_set(theme_bw())

```

# Introduction

The Bureau of Reclamation (BOR), Idaho Governor's Office of Species Conservation (OSC), and an interdisciplinary team of partners have assembled an Upper Salmon Assessment Team to complete biologic and geomorphic analysis in support of future project identification, prioritization and design in the Upper Salmon Subbasin, Idaho. The goal is stream and riparian habitat rehabilitation to support recovery of imperiled Chinook salmon and steelhead populations. The biologic and geomorphic analyses are being lead by Biomark, Inc. (Biomark) and Rio Applied Science and Engineering (Rio ASE), respectively. Previous efforts from the team identified the "problem" within the target watersheds (IRA; Idaho OSC Team 2019). The second phase, termed the Multiple REach Assessments (MRA), includes identifying appropriate and focused "solutions" to the identified capacity problems. To achieve this goal, the team will collaboratively summarize existing and targeted physical habitat conditions relative to documented habitat needs for specific species and life stages, including discussion of high-quality habitat, its creation, and its maintenance to inform future rehabilitation actions.

One of the primary goals of the MRA is to identify target or preferred conditions from a fish's perspective to later translate those into appropriate, target geomorphic conditions. Here, we mine an existing paired fish-habitat dataset from the Columbia River Basin available for 2011-2017 in an effort to describe target conditions for Chinook salmon and steelhead. This is a dataset that is similarly used in Quantile Random Forest (QRF) models to estimate available habitat capacity. We want to explore sites within the dataset that have particularly high juvenile or redd densities and examine distributions of habitat covariates for those sites to see if particular habitat characteristics are related to high densities i.e., do distributions of particular habitat characteristics in high density sites differ from all other sites?

## Objectives

Explore sites within the 2011-2017 paired fish-habitat dataset from ISEMP/CHaMP and determine whether the mean or median values for habitat characteristics in sites with high juvenile fish or redd densities are different than values from all other sites with lower densities. We define high density sites as those in the highest quartile of densities for a given species by life stage scenario. Species and life stage combinations include:

* Species: Chinook salmon, steelhead
* Life Stages: Summer parr, Winter presmolts, Redds

For each scenario, we attempt to identify habitat covariates that are unique to those high density sites i.e., their distribution in the highest quartile sites is different than all sites with lower juvenile fish/redd densities.


# Methods

## Data

The data sources used and described here are described in further detail in Appendix B of the IRA (Idaho OSC Team 2019).

### Study Site

The fish and habitat data span the years 2011-2017 and are from a total of 11 watersheds within the interior Columbia River Basin: Asotin, Entiat, Grande Ronde (upper), John Day, Lemhi, Methow, Minam (tributary of Grande Ronde), Secesh, Tucannon, Wenatchee, and Yankee Fork. Habitat data were collected by the Columbia Habitat Monitoring Program (CHaMP) and juvenile fish and redd data collected at CHaMP surveys sites were provided by several collaborators and projects and included the Integrated Status and Effectiveness Monitoring Program (ISEMP; ISEMP/CHaMP 2017).

### Habitat Data

The habitat data were collected by CHaMP and downloaded from the [CHaMP website](https://www.champmonitoring.org/). CHaMP sites are 200- to 500-meter reaches within wadeable streams across select watersheds within the interior Columbia River Basin and were selected based on a spatially balanced Generalized Tesselation (GRTS) sample selection algorithm (Stevens and Olsen 1999, 2004). Habitat data within CHaMP sites are collected using the CHaMP protocol (CHaMP 2016), which calls for field data collection during the low-flow periods, typically from June through October. CHaMP habitat data include, but are not limited to, measurements describing channel complexity, channel units, disturbance, fish cover, large woody debris, riparian cover, size (depth, width, discharge), substrate, temperature, and water quality.

### Juvenile Fish Data

Juvenile fish surveys were conducted for Chinook salmon and steelhead during the summer and winter low-flow seasons at many of the same sites that were surveyed for habitat using the CHaMP protocol. Fish survey methods to estimate juvenle abundance included mark-recapture, three-pass removal, two-pass removal, and single-pass electrofishing, as well as snorkeling. See et al. (2018) provide further detail on methods used to generate juvenile abundance estimates. Summer sampling and data collection were conducted at the site-scale, whereas winter sampling was conducted at the channel unit scale, and primarily using snorkel surveys.

Juvenile abundance estimates were translated into linear (parr/m) and areal (parr/m$^2$) densities; although here we only use the linear densities for juvenile fish.

### Redd Data

Chinook salmon and steelhead redd data were graciously provided by the Idaho Department of Fish and Game, Nez Perce Tribe Department of Fisheries Resources, Oregon Department of Fish and Wildlife, U.S. Fish and Wildlife Service, and the Washington Department of Fish and Wildlife and span the years 1995 to 2016. Redd data were available for the following CHaMP watersheds: Asotin, Entiat, John Day, Lemhi, Methow, Minam, Secesh, Tucannon, upper Grande Ronde, Wenatchee, and Yankee Fork. The latitude and longitude of each CHaMP site and each redd were snapped to a route in ArcGIS and the number of redds that occurred within 500 meters upstream or downstream of each CHaMP site for each year in which redds were observed were counted and transformed into linear densities (redds/km).

## Analysis

# Results

```{r source-scripts}
source("../R/1_load_data.R")
source("../R/2_clean_data.R")
source("../R/3_parse_data.R")
source("../R/4_metric_list.R")
source("../R/5_wlcx_rs.R")
```

## Chinook salmon

### Summer parr

```{r chnk-sum}
# set parameters
spc = "chnk"
ls  = "sum"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics)

# let's look at the # of significant comparisons by habitat covariate
alpha = 0.1
tst_results %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0)) %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T)) %>%
  ungroup() %>%
  filter(sig_dfs > 0) %>%
  #arrange(desc(sig_dfs)) %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "# of Significant Comparisons",
       title = paste(spc, ls))

# plot meadian and mean p-values
tst_results %>%
  group_by(hab_cov) %>%
  summarise(mn_p = mean(p_value, na.rm = T),
            md_p = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  gather(key, value, mn_p:md_p) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "steelblue4") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p",
       title = paste(spc, ls)) +
  facet_wrap(~ key)

```

### Winter presmolt

```{r chnk-win}
# set parameters
spc = "chnk"
ls  = "win"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics)

# let's look at the # of significant comparisons by habitat covariate
alpha = 0.1
tst_results %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0)) %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T)) %>%
  ungroup() %>%
  filter(sig_dfs > 0) %>%
  #arrange(desc(sig_dfs)) %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "# of Significant Comparisons",
       title = paste(spc, ls))

# plot meadian and mean p-values
tst_results %>%
  group_by(hab_cov) %>%
  summarise(mn_p = mean(p_value, na.rm = T),
            md_p = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  gather(key, value, mn_p:md_p) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "steelblue4") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p",
       title = paste(spc, ls)) +
  facet_wrap(~ key)

```

### Redds

```{r chnk-spw}
# set parameters
spc = "chnk"
ls  = "spw"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics)

# let's look at the # of significant comparisons by habitat covariate
alpha = 0.1
tst_results %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0)) %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T)) %>%
  ungroup() %>%
  filter(sig_dfs > 0) %>%
  #arrange(desc(sig_dfs)) %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "# of Significant Comparisons",
       title = paste(spc, ls))

# plot meadian and mean p-values
tst_results %>%
  group_by(hab_cov) %>%
  summarise(mn_p = mean(p_value, na.rm = T),
            md_p = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  gather(key, value, mn_p:md_p) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "steelblue4") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p",
       title = paste(spc, ls)) +
  facet_wrap(~ key)

```

## Steelhead

### Summer parr

```{r sthd-sum}
# set parameters
spc = "sthd"
ls  = "sum"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics)

# let's look at the # of significant comparisons by habitat covariate
alpha = 0.1
tst_results %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0)) %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T)) %>%
  ungroup() %>%
  filter(sig_dfs > 0) %>%
  #arrange(desc(sig_dfs)) %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "# of Significant Comparisons",
       title = paste(spc, ls))

# plot meadian and mean p-values
tst_results %>%
  group_by(hab_cov) %>%
  summarise(mn_p = mean(p_value, na.rm = T),
            md_p = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  gather(key, value, mn_p:md_p) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "steelblue4") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p",
       title = paste(spc, ls)) +
  facet_wrap(~ key)

```

### Winter presmolt

```{r sthd-win}
# set parameters
spc = "sthd"
ls  = "win"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics)

# let's look at the # of significant comparisons by habitat covariate
alpha = 0.1
tst_results %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0)) %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T)) %>%
  ungroup() %>%
  filter(sig_dfs > 0) %>%
  #arrange(desc(sig_dfs)) %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "# of Significant Comparisons",
       title = paste(spc, ls))

# plot meadian and mean p-values
tst_results %>%
  group_by(hab_cov) %>%
  summarise(mn_p = mean(p_value, na.rm = T),
            md_p = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  gather(key, value, mn_p:md_p) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "steelblue4") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p",
       title = paste(spc, ls)) +
  facet_wrap(~ key)

```

### Redds

```{r sthd-spw}
# set parameters
spc = "sthd"
ls  = "spw"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics)

# let's look at the # of significant comparisons by habitat covariate
alpha = 0.1
tst_results %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0)) %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T)) %>%
  ungroup() %>%
  filter(sig_dfs > 0) %>%
  #arrange(desc(sig_dfs)) %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "# of Significant Comparisons",
       title = paste(spc, ls))

# plot meadian and mean p-values
tst_results %>%
  group_by(hab_cov) %>%
  summarise(mn_p = mean(p_value, na.rm = T),
            md_p = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  gather(key, value, mn_p:md_p) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "steelblue4") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p",
       title = paste(spc, ls)) +
  facet_wrap(~ key)

```

# Discussion

Discussion text...

# Literature Cited

Idaho OSC Team (Idaho Governor’s Office of Species Conservation and partners). 2019. Upper Salmon Subbasin Habitat Integrated Rehabilitation Assessment. Assessment prepared for and with the U.S. Department of the Interior, Bureau of Reclamation. June 2019. 625 pp.

ISEMP/CHaMP. 2017. Integrated Status and Effectiveness Monitoring Program (ISEMP) and Columbia Habitat Monitoring Program (CHaMP) Annual Combined Technical Report, January - December 2016. BPA Projects 2003-017-00 and 2011-006-00, 93 Electronic Pages.