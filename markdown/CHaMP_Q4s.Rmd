---
title: "Mining high density juvenile fish and redd sites in the ISEMP/CHaMP dataset; do particular habitat characteristics stick out in areas with lots of fish/redds?"
author:
  - name: Mike Ackerman
    affiliation: Biomark, Inc.
    email: mike.ackerman@merck.com
  - name: Kevin See
    affiliation: Biomark, Inc.
    email: kevin.see@merck.com
  - name: Richie Carmichael
    affiliation: Biomark, Inc.
    email: richard.carmichael@merck.com
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    smart: false
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_height: 6
    fig_width: 8
    pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
  bookdown::pdf_document2:
    fig_height: 6
    fig_width: 8
    includes:
      in_header: "../templates/header_ABS.tex"
    pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks2.lua
      - --lua-filter=../templates/pagebreak.lua
  bookdown::word_document2:
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    toc: yes
    pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
    reference_docx: "../templates/ReportTemplate.docx"
institute:
  - biomark: Biomark, Inc.
csl: "../templates/american-fisheries-society.csl"
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# load knitr for markdown
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

# load necessary libraries
library(tidyverse)
library(ggplot2)
library(janitor)

# themes and settings
theme_set(theme_bw())

```


# Introduction

The Bureau of Reclamation (BOR), Idaho Governor's Office of Species Conservation (OSC), and an interdisciplinary team of partners have assembled an Upper Salmon Assessment Team to complete biologic and geomorphic analysis in support of future project identification, prioritization and design in the Upper Salmon Subbasin, Idaho. The goal is stream and riparian habitat rehabilitation to support recovery of imperiled Chinook salmon and steelhead populations. The biologic and geomorphic analyses are being lead by Biomark, Inc. (Biomark) and Rio Applied Science and Engineering (Rio ASE), respectively. Previous efforts from the team identified the "problem" within the target watersheds (IRA; Idaho OSC Team 2019). The second phase, termed the Multiple REach Assessments (MRA), includes identifying appropriate and focused "solutions" to the identified capacity problems. To achieve this goal, the team will collaboratively summarize existing and targeted physical habitat conditions relative to documented habitat needs for specific species and life stages, including discussion of high-quality habitat, its creation, and its maintenance to inform future rehabilitation actions.

One of the primary goals of the MRA is to identify target or preferred conditions from a fish's perspective to later translate those into appropriate, target geomorphic conditions. Here, we mine an existing paired fish-habitat dataset from the Columbia River Basin available for 2011-2017 in an effort to describe target conditions for Chinook salmon and steelhead. This is a dataset that is similarly used in Quantile Random Forest (QRF) models to estimate available habitat capacity. We want to explore sites within the dataset that have particularly high juvenile or redd densities and examine distributions of habitat covariates for those sites to see if particular habitat characteristics are related to high densities i.e., do distributions of particular habitat characteristics in high density sites differ from all other sites?

All of the data, scripts, etc. described in the document are available in the [champ_Q4s](https://github.com/mackerman44/champ_Q4s) repo available on www.github.com.

## Objectives

Explore sites within the 2011-2017 paired fish-habitat dataset from ISEMP/CHaMP and determine whether the mean or median values for habitat characteristics in sites with high juvenile fish or redd densities are different than values from all other sites with lower densities. We define high density sites as those in the highest quartile of densities for a given species by life stage scenario. Species and life stage combinations include:

* Species: Chinook salmon, steelhead
* Life Stages: Summer parr, Winter presmolts, Redds

For each scenario, we attempt to identify habitat covariates that are unique to those high density sites i.e., their distribution in the highest quartile sites is different than all sites with lower juvenile fish/redd densities.


# Methods

## Data

The data sources used and described here are described in further detail in Appendix B of the IRA (Idaho OSC Team 2019).

### Study Site

The fish and habitat data span the years 2011-2017 and are from a total of 11 watersheds within the interior Columbia River Basin: Asotin, Entiat, Grande Ronde (upper), John Day, Lemhi, Methow, Minam (tributary of Grande Ronde), Secesh, Tucannon, Wenatchee, and Yankee Fork. Habitat data were collected by the Columbia Habitat Monitoring Program (CHaMP) and juvenile fish and redd data collected at CHaMP surveys sites were provided by several collaborators and projects and included the Integrated Status and Effectiveness Monitoring Program (ISEMP; ISEMP/CHaMP 2017).

### Habitat Data

The habitat data were collected by CHaMP and downloaded from the [CHaMP website](https://www.champmonitoring.org/). CHaMP sites are 200- to 500-meter reaches within wadeable streams across select watersheds within the interior Columbia River Basin and were selected based on a spatially balanced Generalized Tesselation (GRTS) sample selection algorithm (Stevens and Olsen 1999, 2004). Habitat data within CHaMP sites are collected using the CHaMP protocol (CHaMP 2016), which calls for field data collection during the low-flow periods, typically from June through October. CHaMP habitat data include, but are not limited to, measurements describing channel complexity, channel units, disturbance, fish cover, large woody debris, riparian cover, size (depth, width, discharge), substrate, temperature, and water quality.

### Juvenile Fish Data

Juvenile fish surveys were conducted for Chinook salmon and steelhead during the summer and winter low-flow seasons at many of the same sites that were surveyed for habitat using the CHaMP protocol. Fish survey methods to estimate juvenle abundance included mark-recapture, three-pass removal, two-pass removal, and single-pass electrofishing, as well as snorkeling. See et al. (2018) provide further detail on methods used to generate juvenile abundance estimates. Summer sampling and data collection were conducted at the site-scale, whereas winter sampling was conducted at the channel unit scale, and primarily using snorkel surveys.

Juvenile abundance estimates were translated into linear (parr/m) and areal (parr/m$^2$) densities; although here we only use the linear densities for juvenile fish.

### Redd Data

Chinook salmon and steelhead redd data were graciously provided by the Idaho Department of Fish and Game, Nez Perce Tribe Department of Fisheries Resources, Oregon Department of Fish and Wildlife, U.S. Fish and Wildlife Service, and the Washington Department of Fish and Wildlife and span the years 1995 to 2016. Redd data were available for the following CHaMP watersheds: Asotin, Entiat, John Day, Lemhi, Methow, Minam, Secesh, Tucannon, upper Grande Ronde, Wenatchee, and Yankee Fork. The latitude and longitude of each CHaMP site and each redd were snapped to a route in ArcGIS and the number of redds that occurred within 500 meters upstream or downstream of each CHaMP site for each year in which redds were observed were counted and transformed into linear densities (redds/km).

## Analysis

```{r source-scripts}
# source all scripts used in analysis
source("../R/1_load_data.R")
source("../R/2_clean_data.R")
source("../R/3_parse_data.R")
source("../R/4_metric_list.R")
source("../R/5_wlcx_rs.R")
source("../R/fh_plot.R")
```

All of the scripts and data used are available in the [champ_Q4s](https://github.com/mackerman44/champ_Q4s) Git repo. We provide detailed methods for a single species x life stage combination, and in this case, focus on Chinook salmon and summer parr rearing. Similar methods are then applied to both species and all three life stages and we attempt to note differences in methods where appropriate: 

```{r load-data}
# load datasets for methods
sum_df = load_data(ls = "sum")
win_df = load_data(ls = "win")
spw_df = load_data(ls = "spw")

# lists of data parsers for methods
watersheds = unique(c(unique(sum_df$Watershed), as.character(unique(win_df$Watershed)), unique(spw_df$Watershed)))
channel_types = unique(c(unique(sum_df$Channel_Type), unique(spw_df$Channel_Type)))
channel_types = channel_types[!is.na(channel_types)]
tier_1s = as.character(unique(win_df$Tier1))

# set alpha for wilcoxon rank sum tests
alpha = 0.10

```

* Read in the appropriate dataset, according to life stage, using the `load_data()` function in *R/1_load_data.R*. Each dataset contains the following number of records: Summer parr (`r nrow(sum_df)`), winter presmolt (`r nrow(win_df)`), and adult spawning (`r nrow(spw_df)`). Each observation/record includes estimates of juvenile fish/redd abundance and density for a site paired with all of the habitat measurements collected for that site at the same spatial scale. For the summer parr and adult spawning life stages, the data are at the CHaMP site scale. For the winter presmolt life stage, data are at the channel unit scale.
*  Use the `clean_data()` function in *R/2_clean_data.R* to filter, reduce, and prepare the above dataset according to species and life-stage. The `clean_data()` function performs the following steps: 
    + Filter the dataset to only include records for the given species, Chinook salmon or steelhead.
    + Reduce columns in the dataset to include:
        - Fish abundance and linear density estimates; either fish/m for the juvenile rearing life stages or redds/km for the adult spawning life stage.
        - Information that can be used to parse the dataset either by watershed or channel classification (channel type or Tier 1 classification).
        - Relevant habitat measurements/covariates that we are interested in that may be correlated with observed fish/redd densities or useful for habitat rehabilitation.
    + Reduce the dataset to only include records where fish or redds were observed. For records where abundance or density equals 0, sometimes it is unclear whether that was due to the site not being sampled or the site being sampled, but no fish or redds observed.
* Parse the data using the `parse_data()` function in *R/parse_data.R*. The function splits the above dataset by watershed and channel classification. For the summer parr and adult spawning datasets, that channel classification is done according to the **Channel_Type** column and for the winter presmolts dataset using the **Tier1** column. Those columns contain the following unique values:
    + **Watershed:** `r watersheds`
    + **Channel_Type:** `r channel_types`
    + **Tier1:** `r tier_1s`
* We eliminate any parsed data set with too few observations. In our case, we used a minimum sample size of 20.
* After parsing the data by watershed or channel classification, calculate the quartiles of the observed aerial juvenile fish or redd densities. All surveys/sites in the uppermost quartile are assigned to a **Q4** category containing highest densities; all other surveys/sites are assigned to a **Rest** category containing lower densities.
* Finally, after filter/reducing the dataset by species and life stage and then parsing by watershed and channel classification, we compare the means of the habitat measurements between the **Q4** sites and the **Rest** sites using a Wilcoxon rank sum test. This is then repeated across all habitat covariates for each parsed dataset. As an example, for Chinook salmon summer parr, we have datasets for `r sum_df %>% filter(Species == "Chinook") %>% pull(Watershed) %>% unique() %>% length()` watersheds and `r sum_df %>% filter(Species == "Chinook") %>% pull(Channel_Type) %>% unique() %>% length()` channel types and after removing those datasets that are too small we calculate the mean for each covariate for the **Q4** and **Rest** sites and then compare the means and grab the p-value from the Wilcoxon rank sum test performed within each dataset.
* The results then allow us to examine the number of datasets (and which datasets) there was a difference in means for a habitat covariate between high and low density sites. We can also, for example, calculate the mean or median p-value for each habitat covariate.


# Results

## Chinook salmon

### Summer parr

```{r chnk-sum}
# set parameters
spc = "chnk"
ls  = "sum"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)
n_dfs = length(df_list)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics) %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0))

sig_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T),
            p_sig_dfs = sig_dfs / n_dfs) %>%
  ungroup() %>%
  arrange(-sig_dfs) %>%
  filter(sig_dfs > 0)

p_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(Mean = mean(p_value, na.rm = T),
            Median = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  arrange(Median)

```

For Chinook, summer parr, there were `r nrow(sig_results)` habitat covariates that had a significant p-value of less than `r alpha` in at least 1 of the `r length(df_list)` datasets evaluated including `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% nrow()` covariates that were significant in $\geq\frac{1}{2}$ of the datasets (Figure \@ref(fig:chnk-sum-sig-tests)). Those covariates include: `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% pull(hab_cov)`.

```{r chnk-sum-sig-tests, fig.cap = "The number of comparisons, among data frames evaluated, where the mean of a habitat covariate was significantly different between those CHaMP sites with juvenile Chinook salmon estimated densities in the upper quartile versus all other sites where juveniles were observed. Comparisons were made using a Wilcoxon rank sum test."}
# let's look at the # of significant comparisons by habitat covariate
sig_results %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = p_sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p(Significant Comparisons)",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets"))

```

We further summarized the mean and median p-value among the Wilcoxon rank sum tests performed in each `r length(df_list)` datasets and for each habitat covariate (Figure \@ref(fig:chnk-sum-p-val)). There were `r p_results %>% filter(Median <= alpha) %>% nrow()` habitat covariate(s) that had a median p-value $\leq$ our $\alpha =$ `r alpha` which include: `r p_results %>% filter(Median <= alpha) %>% pull(hab_cov)`.

```{r chnk-sum-p-val, fig.cap = "The median (md_p) and mean (mn_p) p-values from Wilcoxon rank sum tests for each covariate when comparisons were made for all sites with juvenile Chinook salmon densities in the upper quartile versus all other sites with fish oservations."}
# plot median and mean p-values
p_results %>%
  gather(key, value, Mean:Median) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "orangered3") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p-value",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets")) +
  facet_wrap(~ key)

```

```{r chnk-sum-targets}
# list of metrics to plot/summarize for scenario
hab_list = c("Q", "Cond")

# find datasets where hab_list were significant
sig_hab_df = tst_results %>%
  filter(hab_cov %in% hab_list,
         sig == 1)

```

### Winter presmolt

```{r chnk-win}
# set parameters
spc = "chnk"
ls  = "win"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)
n_dfs = length(df_list)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics) %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0))

sig_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T),
            p_sig_dfs = sig_dfs / n_dfs) %>%
  ungroup() %>%
  arrange(-sig_dfs) %>%
  filter(sig_dfs > 0)

p_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(Mean = mean(p_value, na.rm = T),
            Median = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  arrange(Median)

```

For Chinook, winter presmolts, there were `r nrow(sig_results)` habitat covariates that had a significant p-value of less than `r alpha` in at least 1 of the `r length(df_list)` datasets evaluated including `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% nrow()` covariates that were significant in $\geq\frac{1}{2}$ of the datasets (Figure \@ref(fig:chnk-win-sig-tests)). Those covariates include: `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% pull(hab_cov)`.

```{r chnk-win-sig-tests, fig.cap = "The number of comparisons, among data frames evaluated, where the mean of a habitat covariate was significantly different between those CHaMP sites with juvenile Chinook salmon estimated densities in the upper quartile versus all other sites where juveniles were observed. Comparisons were made using a Wilcoxon rank sum test."}
# let's look at the # of significant comparisons by habitat covariate
sig_results %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = p_sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p(Significant Comparisons)",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets"))

```

We further summarized the mean and median p-value among the Wilcoxon rank sum tests performed in each `r length(df_list)` datasets and for each habitat covariate (Figure \@ref(fig:chnk-win-p-val)). There were `r p_results %>% filter(Median <= alpha) %>% nrow()` habitat covariate(s) that had a median p-value $\leq$ our $\alpha =$ `r alpha` which include: `r p_results %>% filter(Median <= alpha) %>% pull(hab_cov)`.

```{r chnk-win-p-val, fig.cap = "The median (md_p) and mean (mn_p) p-values from Wilcoxon rank sum tests for each covariate when comparisons were made for all sites with juvenile Chinook salmon densities in the upper quartile versus all other sites with fish oservations."}
# plot median and mean p-values
p_results %>%
  gather(key, value, Mean:Median) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "orangered3") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p-value",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets")) +
  facet_wrap(~ key)

```

### Redds

```{r chnk-spw}
# set parameters
spc = "chnk"
ls  = "spw"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)
n_dfs = length(df_list)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics) %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0))

sig_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T),
            p_sig_dfs = sig_dfs / n_dfs) %>%
  ungroup() %>%
  arrange(-sig_dfs) %>%
  filter(sig_dfs > 0)

p_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(Mean = mean(p_value, na.rm = T),
            Median = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  arrange(Median)

```

For Chinook, adult spawning, there were `r nrow(sig_results)` habitat covariates that had a significant p-value of less than `r alpha` in at least 1 of the `r length(df_list)` datasets evaluated including `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% nrow()` covariates that were significant in $\geq\frac{1}{2}$ of the datasets (Figure \@ref(fig:chnk-spw-sig-tests)). Those covariates include: `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% pull(hab_cov)`.

```{r chnk-spw-sig-tests, fig.cap = "The number of comparisons, among data frames evaluated, where the mean of a habitat covariate was significantly different between those CHaMP sites with Chinook salmon estimated redd densities in the upper quartile versus all other sites where redds were observed. Comparisons were made using a Wilcoxon rank sum test."}
# let's look at the # of significant comparisons by habitat covariate
sig_results %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = p_sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p(Significant Comparisons)",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets"))

```

We further summarized the mean and median p-value among the Wilcoxon rank sum tests performed in each `r length(df_list)` datasets and for each habitat covariate (Figure \@ref(fig:chnk-spw-p-val)). There were `r p_results %>% filter(Median <= alpha) %>% nrow()` habitat covariate(s) that had a median p-value $\leq$ our $\alpha =$ `r alpha` which include: `r p_results %>% filter(Median <= alpha) %>% pull(hab_cov)`.

```{r chnk-spw-p-val, fig.cap = "The median (md_p) and mean (mn_p) p-values from Wilcoxon rank sum tests for each covariate when comparisons were made for all sites with Chinook salmon redd densities in the upper quartile versus all other sites with redd observations."}
# plot median and mean p-values
p_results %>%
  gather(key, value, Mean:Median) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "orangered3") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p-value",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets")) +
  facet_wrap(~ key)

```


## Steelhead

### Summer parr

```{r sthd-sum}
# set parameters
spc = "sthd"
ls  = "sum"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)
n_dfs = length(df_list)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics) %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0))

sig_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T),
            p_sig_dfs = sig_dfs / n_dfs) %>%
  ungroup() %>%
  arrange(-sig_dfs) %>%
  filter(sig_dfs > 0)

p_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(Mean = mean(p_value, na.rm = T),
            Median = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  arrange(Median)

```

For steelhead, summer parr, there were `r nrow(sig_results)` habitat covariates that had a significant p-value of less than `r alpha` in at least 1 of the `r length(df_list)` datasets evaluated including `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% nrow()` covariates that were significant in $\geq\frac{1}{2}$ of the datasets (Figure \@ref(fig:sthd-sum-sig-tests)). Those covariates include: `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% pull(hab_cov)`.

```{r sthd-sum-sig-tests, fig.cap = "The number of comparisons, among data frames evaluated, where the mean of a habitat covariate was significantly different between those CHaMP sites with juvenile steelhead estimated densities in the upper quartile versus all other sites where juveniles were observed. Comparisons were made using a Wilcoxon rank sum test."}
# let's look at the # of significant comparisons by habitat covariate
sig_results %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = p_sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p(Significant Comparisons)",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets"))

```

We further summarized the mean and median p-value among the Wilcoxon rank sum tests performed in each `r length(df_list)` datasets and for each habitat covariate (Figure \@ref(fig:sthd-sum-p-val)). There were `r p_results %>% filter(Median <= alpha) %>% nrow()` habitat covariate(s) that had a median p-value $\leq$ our $\alpha =$ `r alpha` which include: `r p_results %>% filter(Median <= alpha) %>% pull(hab_cov)`.

```{r sthd-sum-p-val, fig.cap = "The median (md_p) and mean (mn_p) p-values from Wilcoxon rank sum tests for each covariate when comparisons were made for all sites with juvenile steelhead densities in the upper quartile versus all other sites with fish observations."}
# plot median and mean p-values
p_results %>%
  gather(key, value, Mean:Median) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "orangered3") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p-value",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets")) +
  facet_wrap(~ key)

```

### Winter presmolt

```{r sthd-win}
# set parameters
spc = "sthd"
ls  = "win"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)
n_dfs = length(df_list)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics) %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0))

sig_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T),
            p_sig_dfs = sig_dfs / n_dfs) %>%
  ungroup() %>%
  arrange(-sig_dfs) %>%
  filter(sig_dfs > 0)

p_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(Mean = mean(p_value, na.rm = T),
            Median = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  arrange(Median)

```

For steelhead, winter presmolts, there were `r nrow(sig_results)` habitat covariates that had a significant p-value of less than `r alpha` in at least 1 of the `r length(df_list)` datasets evaluated including `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% nrow()` covariates that were significant in $\geq\frac{1}{2}$ of the datasets (Figure \@ref(fig:sthd-win-sig-tests)). Those covariates include: `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% pull(hab_cov)`.

```{r sthd-win-sig-tests, fig.cap = "The number of comparisons, among data frames evaluated, where the mean of a habitat covariate was significantly different between those CHaMP sites with juvenile steelhead estimated densities in the upper quartile versus all other sites where juveniles were observed. Comparisons were made using a Wilcoxon rank sum test."}
# let's look at the # of significant comparisons by habitat covariate
sig_results %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = p_sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p(Significant Comparisons)",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets"))

```

We further summarized the mean and median p-value among the Wilcoxon rank sum tests performed in each `r length(df_list)` datasets and for each habitat covariate (Figure \@ref(fig:sthd-win-p-val)). There were `r p_results %>% filter(Median <= alpha) %>% nrow()` habitat covariate(s) that had a median p-value $\leq$ our $\alpha =$ `r alpha` which include: `r p_results %>% filter(Median <= alpha) %>% pull(hab_cov)`.

```{r sthd-win-p-val, fig.cap = "The median (md_p) and mean (mn_p) p-values from Wilcoxon rank sum tests for each covariate when comparisons were made for all sites with juvenile steelhead densities in the upper quartile versus all other sites with fish observations."}
# plot median and mean p-values
p_results %>%
  gather(key, value, Mean:Median) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "orangered3") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p-value",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets")) +
  facet_wrap(~ key)

```

### Redds

```{r sthd-spw}
# set parameters
spc = "sthd"
ls  = "spw"

# load data
ls_df = load_data(ls)

# clean, reduce data
spc_ls_hab_df = clean_data(data = ls_df, spc = spc, ls = ls)

# parse data by watershed, channel unit type, and/or tier 1
df_list = parse_data(data = spc_ls_hab_df, spc = spc, ls = ls)
n_dfs = length(df_list)

# generate lists for evaluation & plotting
metrics = metric_list(ls = ls)

# compare means by dataset and habitat covariate
tst_results = wlcx_rs_test(df_list, metrics) %>%
  mutate(sig = ifelse(p_value <= alpha, 1, 0))

sig_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(sig_dfs = sum(sig, na.rm = T),
            p_sig_dfs = sig_dfs / n_dfs) %>%
  ungroup() %>%
  arrange(-sig_dfs) %>%
  filter(sig_dfs > 0)

p_results = tst_results %>%
  group_by(hab_cov) %>%
  summarise(Mean = mean(p_value, na.rm = T),
            Median = median(p_value, na.rm = T)) %>%
  ungroup() %>%
  arrange(Median)

```

For steelhead, adult spawning, there were `r nrow(sig_results)` habitat covariates that had a significant p-value of less than `r alpha` in at least 1 of the `r length(df_list)` datasets evaluated including `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% nrow()` covariates that were significant in $\geq\frac{1}{2}$ of the datasets (Figure \@ref(fig:sthd-spw-sig-tests)). Those covariates include: `r sig_results %>% filter(p_sig_dfs >= 0.5) %>% pull(hab_cov)`.

```{r sthd-spw-sig-tests, fig.cap = "The number of comparisons, among data frames evaluated, where the mean of a habitat covariate was significantly different between those CHaMP sites with steelhead estimated redd densities in the upper quartile versus all other sites where redds were observed. Comparisons were made using a Wilcoxon rank sum test."}
# let's look at the # of significant comparisons by habitat covariate
sig_results %>%
  ggplot(aes(x = reorder(hab_cov, sig_dfs),
             y = p_sig_dfs)) +
  geom_col(fill = "steelblue4") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p(Significant Comparisons)",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets"))

```

We further summarized the mean and median p-value among the Wilcoxon rank sum tests performed in each `r length(df_list)` datasets and for each habitat covariate (Figure \@ref(fig:sthd-spw-p-val)). There were `r p_results %>% filter(Median <= alpha) %>% nrow()` habitat covariate(s) that had a median p-value $\leq$ our $\alpha =$ `r alpha` which include: `r p_results %>% filter(Median <= alpha) %>% pull(hab_cov)`.

```{r sthd-spw-p-val, fig.cap = "The median (md_p) and mean (mn_p) p-values from Wilcoxon rank sum tests for each covariate when comparisons were made for all sites with steelhead redd densities in the upper quartile versus all other sites with redd observations."}
# plot median and mean p-values
p_results %>%
  gather(key, value, Mean:Median) %>%
  ggplot(aes(x = reorder(hab_cov, -value),
             y = value)) +
  geom_col(fill = "orangered3") +
  geom_hline(yintercept = alpha, color = "red") +
  theme_bw() +
  coord_flip() +
  labs(x = "Habitat Covariate",
       y = "p-value",
       title = paste0(spc, " ", ls, "; ", n_dfs, " datasets")) +
  facet_wrap(~ key)

```


# Discussion

Discussion text...


# Literature Cited

Idaho OSC Team (Idaho Governorâ€™s Office of Species Conservation and partners). 2019. Upper Salmon Subbasin Habitat Integrated Rehabilitation Assessment. Assessment prepared for and with the U.S. Department of the Interior, Bureau of Reclamation. June 2019. 625 pp.

ISEMP/CHaMP. 2017. Integrated Status and Effectiveness Monitoring Program (ISEMP) and Columbia Habitat Monitoring Program (CHaMP) Annual Combined Technical Report, January - December 2016. BPA Projects 2003-017-00 and 2011-006-00, 93 Electronic Pages.